<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StorageChat LLM ëŒ€í™” í…ŒìŠ¤íŠ¸</title>
  <style>
    /* --- High-contrast, clean dark UI --- */
    :root {
      --bg:#0d0f14;           /* page background */
      --panel:#191c22;        /* card background (lighter for contrast) */
      --muted:#2a2f39;        /* borders */
      --text:#f2f4f8;         /* primary text */
      --sub:#c0c6d1;          /* secondary text */
      --brand:#e3c468;        /* brand accent */
      --brand-2:#fed96b;      /* brighter hover */
      --ok:#2ea043;           /* ok */
      --err:#ff5c66;          /* error */
      --chip:#222735;         /* chip background */
      --input:#1f2430;        /* input background */
      --ai:#2b3140;           /* ai bubble */
      --me:#c9cbd1;           /* me bubble */
      --meText:#0d0f14;       /* me bubble text */
      --pilot:#3a4258;        /* pilot row tint */
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    .app{display:grid;grid-template-columns:1.2fr .9fr;gap:18px;height:100%;padding:18px;box-sizing:border-box}
    .card{background:var(--panel);border:1px solid var(--muted);border-radius:16px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--muted);font-size:18px;font-weight:800}
    /* Chat */
    .chat{display:flex;flex-direction:column;min-height:0}
    .messages{flex:1;overflow:auto;padding:16px;scroll-behavior:smooth}
    .row{display:flex;margin-bottom:12px}
    .row.system{justify-content:center;opacity:.85}
    .bubble{max-width:74%;padding:12px 14px;border-radius:14px;line-height:1.5;white-space:pre-wrap}
    .me .bubble{margin-left:auto;background:var(--me);color:var(--meText)}
    .ai .bubble{margin-right:auto;background:var(--ai);color:var(--text)}
    .foot{display:flex;gap:10px;padding:12px;border-top:1px solid var(--muted);align-items:center}
    .input{flex:1;display:flex;align-items:center;background:var(--input);border:1px solid var(--muted);border-radius:12px;padding:6px 10px}
    .input input{flex:1;background:transparent;border:0;outline:none;color:var(--text);font-size:15px}
    .btn{border:0;border-radius:12px;padding:10px 14px;background:var(--chip);color:var(--text);cursor:pointer;transition:transform .06s ease, background .15s ease}
    .btn.primary{background:var(--brand);color:#111;font-weight:800}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary:hover{background:var(--brand-2)}
    .btn:focus{outline:2px solid var(--brand);outline-offset:2px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .chips{display:flex;gap:8px;flex-wrap:wrap;padding:8px 12px;border-bottom:1px solid var(--muted);background:rgba(255,255,255,.02)}
.chip {
  background: #3a3a3f;              /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
  color: #ffffff;                   /* ê¸€ììƒ‰ í°ìƒ‰ */
  border: 1px solid var(--muted);   /* í…Œë‘ë¦¬ ìœ ì§€ */
  padding: 9px 14px;                /* ê¸°ì¡´ë³´ë‹¤ ì‚´ì§ í¬ê²Œ */
  border-radius: 999px;             /* pill ìŠ¤íƒ€ì¼ */
  font-size: 13px;                  /* ê¸€ì”¨ í¬ê¸° ì—… */
  cursor: pointer;
  transition: background 0.2s ease, transform 0.1s ease;
}

.chip:hover {
  background: #505055;              /* hover ì‹œ ì¢€ ë” ë°ì€ íšŒìƒ‰ */
  transform: translateY(-1px);      /* ì‚´ì§ ë– ì˜¤ë¦„ íš¨ê³¼ */
}
    .muted{color:var(--sub)}
    /* Autocomplete */
    .ac{position:absolute;left:16px;right:16px;bottom:86px;max-height:260px;overflow:auto;background:#141822;border:1px solid var(--muted);border-radius:12px;display:none;z-index:5}
    .ac ul{list-style:none;margin:0;padding:6px}
    .ac li{padding:9px 11px;border-radius:8px;cursor:pointer}
    .ac li:hover{background:#1b2130}
    /* Right column */
    .search{padding:12px;display:flex;flex-direction:column;gap:10px}
    .field{display:flex;gap:8px}
    .field input, .field select{flex:1;background:var(--input);border:1px solid var(--muted);border-radius:12px;color:var(--text);padding:10px 12px;font-size:14px}
    .list{flex:1;overflow:auto;border-top:1px dashed var(--muted)}
    .item{padding:12px;border-bottom:1px solid var(--muted);cursor:pointer;display:flex;justify-content:space-between;gap:10px;align-items:center}
    .item:hover{background:#1a2130}
    .left{display:flex;flex-direction:column;gap:4px}
    .right{display:flex;gap:8px;align-items:center}
    .mng{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New", monospace;background:#10131a;border:1px solid #2b3240;border-radius:8px;padding:2px 6px}
    .badge{display:inline-block;background:#262d3d;border:1px solid var(--muted);border-radius:8px;padding:3px 8px;font-size:11px}
    .pilot-badge{background:var(--pilot);border-color:#4a5470}
    .hint{font-size:12px;color:var(--sub);padding:10px 12px}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#121622;border:1px solid var(--muted);border-radius:999px;padding:7px 10px;font-size:12px}
    .toolbar{display:flex;gap:8px;align-items:center}
    .toggle{display:flex;gap:8px;align-items:center}
    .divider{height:1px;background:var(--muted);margin:6px 0}
    @media(max-width:1000px){.app{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="app">
    <!-- Left: Chat -->
    <section class="card chat" id="chatCard">
      <h2>StorageChat LLM ëŒ€í™” í…ŒìŠ¤íŠ¸</h2>

      <div class="chips" id="catChips"></div>

      <div class="messages" id="messages"></div>

      <div class="foot">
        <div class="pill" title="í˜„ì¬ ì„¸ì…˜ ì‹ë³„ê°’">
          <span>ì„¸ì…˜</span>
          <strong id="sid">-</strong>
        </div>
        <div style="flex:1;position:relative">
          <div class="input">
            <input id="input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦ (ì˜ˆ: ì‘í’ˆì˜ ì£¼ì œê°€ ë¬´ì—‡ì¸ê°€ìš”?)" autocomplete="off" />
            <button class="btn" id="speakBtn" title="ì½ì–´ì£¼ê¸°">ğŸ”ˆ</button>
          </div>
          <div class="ac" id="ac"><ul id="acList"></ul></div>
        </div>
        <button class="btn primary" id="send">ì „ì†¡</button>
      </div>
      <div class="hint">StorageChatMobileÂ® ë² íƒ€: ì˜ëª»ëœ ë‹µì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. | ì˜¤ë¥¸ìª½ì—ì„œ mngnoë¥¼ ì„ íƒ/ì…ë ¥í•˜ì„¸ìš”.</div>
    </section>

    <!-- Right: Manage number quick select -->
    <aside class="card" style="min-height:0">
      <h2>ê´€ë¦¬ë²ˆí˜¸ ì„ íƒ</h2>
      <div class="search">
        <!-- Toolbar: apply mngno + search + toggles -->
        <div class="field">
          <input id="mngInput" placeholder="ì˜ˆ: f03569 ë˜ëŠ” 3569" />
          <button class="btn" id="applyMng">ì ìš©</button>
        </div>
        <div class="toolbar">
          <div class="pill">í˜„ì¬ mngno: <strong id="mngno">(ì—†ìŒ)</strong></div>
          <div class="toggle">
            <input type="checkbox" id="onlyPilot" />
            <label for="onlyPilot" class="muted">ì‹¤ì¦ìš©ë§Œ ë³´ê¸° (9)</label>
          </div>
        </div>
        <div class="field">
          <input id="filter" placeholder="ì „ì²´ ë¦¬ìŠ¤íŠ¸ ê²€ìƒ‰: ë²ˆí˜¸Â·ì œëª©Â·ì‘ê°€ (deviceInfo.json ê¸°ë°˜)" />
        </div>
        <div class="divider"></div>
        <div class="list" id="resultList"></div>
      </div>
    </aside>
  </div>

  <script>
    // ======================================================
    // CONFIG
    // ======================================================
    const ENDPOINT = 'https://atfuturelab.sogang.ac.kr:40000/mngno';
    const USE_TTS = true; // Web Speech API

    // Pilot (ì‹¤ì¦ìš©) 9 artworks with source URLs
    // NOTE: We will tag matching mngno in the master list as pilot=true and attach url.
    const PILOT_ITEMS = [
      { mngno:'f03956', title:'ê¹€ë³µì§„ <ë¯¸ë¥µë¶ˆ>', url:'https://www.mmca.go.kr/collections/collectionsDetailPage.do?museumId=&wrkinfoSeqno=3956&artistnm=ê¹€ë³µì§„&wrkMngNo=03956&pageOrder=Wrkinfo_Seqno' },
      { mngno:'f06685', title:'ì´ìˆ˜ê²½ <ë²ˆì—­ëœ ë„ìê¸°>', url:'https://www.mmca.go.kr/collections/collectionsDetailPage.do?museumId=&wrkinfoSeqno=6685&artistnm=ì´ìˆ˜ê²½&wrkMngNo=06685&pageOrder=Wrkinfo_Seqno' },
      { mngno:'f08164', title:'ìµœì •í™” <ë‚´ì¼ì˜ ê½ƒ>', url:'https://www.mmca.go.kr/collections/collectionsDetailPage.do?museumId=&wrkinfoSeqno=8598&artistnm=ìµœì •í™”&wrkMngNo=08164&pageOrder=Wrkinfo_Seqno' },
      { mngno:'f05301', title:'ê¶Œì§„ê·œ <ë§>', url:'https://www.mmca.go.kr/collections/collectionsDetailPage.do?museumId=&wrkinfoSeqno=5301&artistnm=ê¶Œì§„ê·œ&wrkMngNo=05301&pageOrder=Wrkinfo_Seqno' },
      { mngno:'f04027', title:'ì´ê±´ìš© <ê´€ê³„í•­>', url:'https://www.mmca.go.kr/collections/collectionsDetailPage.do?museumId=&wrkinfoSeqno=4027&artistnm=ì´ê±´ìš©&wrkMngNo=04027&pageOrder=Wrkinfo_Seqno' },
      { mngno:'f07541', title:'ìµœì¢…íƒœ <ìƒê°í•˜ëŠ” ì‚¬ëŒ>', url:'https://www.mmca.go.kr/collections/collectionsDetailPage.do?museumId=&wrkinfoSeqno=7554&artistnm=ìµœì¢…íƒœ&wrkMngNo=07541&pageOrder=Wrkinfo_Seqno' },
      { mngno:'f07812', title:'ê¶Œì˜¤ìƒ <íŠ¸ë¦¬>', url:'https://www.mmca.go.kr/collections/collectionsDetailPage.do?museumId=&wrkinfoSeqno=7825&artistnm=ê¶Œì˜¤ìƒ&wrkMngNo=07812&pageOrder=Wrkinfo_Seqno' },
      { mngno:'f04423', title:'ê¹€ì •ìˆ™ <ë¹„ìƒ>', url:'https://www.mmca.go.kr/collections/collectionsDetailPage.do?museumId=&wrkinfoSeqno=4423&artistnm=ê¹€ì •ìˆ™ a&wrkMngNo=04423&pageOrder=Wrkinfo_Seqno' },
      { mngno:'f02107', title:'ë¬¸ì‹  <ê°œë¯¸(ë¼ í›„ë£¨ë¯¸)>', url:'https://www.mmca.go.kr/collections/collectionsDetailPage.do?museumId=&wrkinfoSeqno=2107&artistnm=ë¬¸ì‹ &wrkMngNo=02107&pageOrder=Wrkinfo_Seqno' },
    ];

    // Example quick prompts (chips)
    const EXAMPLES = {
"ì‘í’ˆê´€ë ¨": [
                "ê´€ë ¨ëœ ì‘í’ˆì—ëŠ” ì–´ë–¤ ê²ƒë“¤ì´ ìˆë‚˜ìš”?",
                "ì‘í’ˆì˜ ì£¼ì œê°€ ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘í’ˆì˜ ì œì‘ ë™ê¸°ì™€ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘í’ˆì´ ì „ë‹¬í•˜ê³ ì í•˜ëŠ” ë©”ì‹œì§€ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘í’ˆì—ì„œ ì‚¬ìš©ëœ ì¬ë£ŒëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘í’ˆ ì œì‘ ì‹œ ì‚¬ìš©ëœ ê¸°ë²•ì€ ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘í’ˆì˜ ì² í•™ì  ë°°ê²½ì€ ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘í’ˆì˜ ì„¤ì¹˜ ë°©ì‹ì´ ì£¼ëŠ” ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘í’ˆì˜ ê°ìƒ í¬ì¸íŠ¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                "ì´ ì‘í’ˆì˜ ì£¼ì œì™€ ë©”ì‹œì§€ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘í’ˆì˜ ì œëª©ì— ë‹´ê¸´ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘í’ˆì˜ í¬ê¸°ê°€ ì „í•˜ëŠ” ëŠë‚Œì€ ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘í’ˆì—ì„œ ì‚¬ìš©ëœ ìƒ‰ìƒì˜ ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?"
            ],
        "ì‘ê°€ê´€ë ¨": [
                "ì‘ê°€ì˜ ë‹¤ë¥¸ ëŒ€í‘œì‘ì€ ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘ê°€ì˜ ìƒì• ì™€ ì˜ˆìˆ  í™œë™ì€ ì–´ë– í–ˆë‚˜ìš”?",
                "ì‘ê°€ê°€ ì´ ì‘í’ˆì„ ë§Œë“  ë™ê¸°ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘ê°€ì—ê²Œ ì˜í–¥ì„ ì¤€ ì£¼ìš” ìš”ì†ŒëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘ê°€ê°€ ì†í•œ ì˜ˆìˆ  ì‚¬ì¡°ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘ê°€ì˜ ì˜ˆìˆ  ì„¸ê³„ëŠ” ì–´ë–¤ê°€ìš”?",
                "ì‘ê°€ê°€ íƒêµ¬í•˜ëŠ” ì£¼ìš” ì£¼ì œëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘ê°€ê°€ ì „ë‹¬í•˜ê³ ì í•œ ì£¼ì œì˜ì‹ì€ ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘ê°€ì˜ ì˜ˆìˆ ì  ì ‘ê·¼ë²•ì— ëŒ€í•´ ì„¤ëª…í•´ ì£¼ì„¸ìš”",
                "ì‘ê°€ê°€ ì´ ì‘í’ˆì—ì„œ í‘œí˜„í•˜ê³ ì í•œ ë©”ì‹œì§€ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘ê°€ê°€ ì‚¬ìš©í•œ ì¬ë£Œì˜ ìƒì§•ì„±ì€ ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘ê°€ê°€ ì´ ì‘í’ˆì„ í†µí•´ ì „ë‹¬í•˜ë ¤ í–ˆë˜ ê°ì •ì€ ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘ê°€ì˜ ì‘í’ˆ ì„¸ê³„ë¥¼ ê°„ë‹¨íˆ ì„¤ëª…í•´ ì£¼ì„¸ìš”",
                "ì‘ê°€ê°€ ì´ ì‘í’ˆì„ í†µí•´ ê´€ê°ì—ê²Œ ì „í•˜ê³ ì í•œ ê°ì •ì€ ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‘ê°€ê°€ ì´ ì‘í’ˆì„ ì œì‘í•˜ë©° í’ˆì—ˆë˜ ê°ì •ì€ ë¬´ì—‡ì¸ê°€ìš”?"
            ],
        "ì‹œëŒ€ê´€ë ¨": [
                "ì‘í’ˆì´ ë§Œë“¤ì–´ì§„ ì‹œëŒ€ì  ë°°ê²½ì€ ì–´ë–¤ê°€ìš”?",
                "ì‘í’ˆì˜ ì£¼ì œì™€ ê´€ë ¨ëœ ì‹œëŒ€ìƒì€ ì–´ë–¤ê°€ìš”?",
                "í•´ë‹¹ ì‹œëŒ€ì˜ ì£¼ìš” ì˜ˆìˆ ì  íë¦„ì€ ë¬´ì—‡ì´ì—ˆë‚˜ìš”?",
                "ê·¸ ì‹œëŒ€ì˜ ì‚¬íšŒì  ë°°ê²½ì€ ì–´ë– í–ˆë‚˜ìš”?",
                "ì‘í’ˆì´ ë°˜ì˜í•˜ëŠ” ë‹¹ì‹œ ì‚¬íšŒì  ì´ìŠˆëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                "ê·¸ ì‹œëŒ€ì˜ ë‹¤ë¥¸ ì£¼ìš” ì‘í’ˆë“¤ì€ ë¬´ì—‡ì¸ê°€ìš”?",
                "í•´ë‹¹ ì‹œëŒ€ì˜ ì˜ˆìˆ ê°€ë“¤ì´ ì¶”êµ¬í–ˆë˜ ë©”ì‹œì§€ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                "ì‹œëŒ€ì  íë¦„ê³¼ ì‘ê°€ì˜ ì‘í’ˆì´ ì–´ë–»ê²Œ ì—°ê²°ë˜ë‚˜ìš”?"
        ],
        "ê¸°íƒ€": [
            "ì‘ê°€ì˜ ê°œì¸ì  ì´ë ¥ì„ ì•Œë ¤ì£¼ì„¸ìš”",
            "ì‘ê°€ì˜ ì‘í’ˆì€ í˜„ì¬ ì–´ë””ì— ì „ì‹œë˜ì–´ ìˆë‚˜ìš”?",
            "ì‘í’ˆì˜ ì„¤ì¹˜ ìœ„ì¹˜ê°€ ì˜ë¯¸í•˜ëŠ” ë°”ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
            "ì‘í’ˆì´ ëŒ€ì¤‘ì—ê²Œ ë°›ì€ ë°˜ì‘ì€ ì–´ë• ë‚˜ìš”?",
            "ì‘í’ˆì´ ì²­ì£¼ê´€ì— ì „ì‹œëœ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
            "ì‘í’ˆì´ ì „ì‹œëœ ê³µê°„ì´ ì£¼ëŠ” ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
            "ì‘í’ˆì´ ì£¼ëŠ” ê°ë™ì€ ì–´ë–¤ê°€ìš”?",
            "ì‘í’ˆì˜ ì œì‘ ê³¼ì •ì—ì„œ ì–´ë ¤ì› ë˜ ì ì€ ë¬´ì—‡ì¸ê°€ìš”?",
            "ì‘í’ˆì´ ê´€ê°ì—ê²Œ ì „ë‹¬í•˜ê³ ì í•˜ëŠ” ë©”ì‹œì§€ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
            "ì‘í’ˆì˜ ìƒì§•ì  í¬ì¸íŠ¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”",
            "ì‘í’ˆì„ ê°ìƒí•  ë•Œ ì£¼ì˜í•´ì•¼ í•  ì ì€ ë¬´ì—‡ì¸ê°€ìš”?"
        ]
    };

    // ======================================================
    // STATE
    // ======================================================
    let sessionId = localStorage.getItem('sc_session_id') || null; // persisted session id
    let currentMngno = null;   // selected mngno for chat
    let lastAIMsg = '';
    let allItems = [];         // full list from deviceInfo.json (with pilot tagging)

    // ======================================================
    // DOM REFS
    // ======================================================
    const $ = (q)=>document.querySelector(q);
    const el = (t,c)=>{const e=document.createElement(t); if(c) e.className=c; return e;};

    const messagesEl = $('#messages');
    const inputEl = $('#input');
    const sendBtn = $('#send');
    const sidEl = $('#sid');
    const mngnoEl = $('#mngno');
    const mngInput = $('#mngInput');
    const applyMng = $('#applyMng');
    const filter = $('#filter');
    const resultList = $('#resultList');
    const speakBtn = $('#speakBtn');
    const acBox = document.getElementById('ac');
    const acList = document.getElementById('acList');
    const onlyPilot = document.getElementById('onlyPilot');

    // ======================================================
    // CHAT UI HELPERS
    // ======================================================
    function addMessage(text, who){
      const row = el('div','row '+who);
      const bubble = el('div','bubble');
      bubble.textContent = text;
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function setSession(id){ sessionId = id; localStorage.setItem('sc_session_id', id); sidEl.textContent = id ? id.slice(0,8) : '-'; }
    function setMngno(v){ currentMngno=v; mngnoEl.textContent = v || '(ì—†ìŒ)'; }

    function renderCategories(){
      const wrap = document.getElementById('catChips');
      wrap.innerHTML = '';
      Object.keys(EXAMPLES).forEach(cat=>{
        const chip = el('button','chip'); chip.textContent=cat;
        chip.addEventListener('click',()=>openPicker(cat));
        wrap.appendChild(chip);
      });
    }

    function openPicker(cat){
      const list = EXAMPLES[cat]||[];
      acList.innerHTML = '';
      list.forEach(q=>{
        const li = document.createElement('li');
        li.textContent=q; li.addEventListener('click',()=>{ inputEl.value=q; hideAC(); inputEl.focus(); });
        acList.appendChild(li);
      });
      showAC();
    }

    function showAC(){ acBox.style.display='block'; }
    function hideAC(){ acBox.style.display='none'; }

    // ======================================================
    // LIST (RIGHT PANEL)
    // ======================================================
    function tagPilots(items){
      const pilotSet = new Map(PILOT_ITEMS.map(p=>[p.mngno, p]));
      return items.map(it=>{
        const p = pilotSet.get(it.mngno);
        if(p){ return { ...it, pilot:true, url:p.url, pilotTitle:p.title }; }
        return { ...it, pilot:false };
      });
    }

    async function loadDeviceInfo(){
      try{
        const res = await fetch('./deviceInfo.json');
        const data = await res.json();
        // Convert object â†’ array (include artist if present for search)
        const base = Object.values(data).map(item=>({
          mngno: item.mngno,
          title: item.title,
          artist: item.artist || ''
        }));
        allItems = tagPilots(base);
        renderSampleList();
      }catch(err){
        console.error('deviceInfo.json load failed:', err);
        // Fallback minimal list if JSON missing (keeps UI usable)
        allItems = tagPilots([]);
        renderSampleList();
      }
    }

    function renderSampleList(){
      const q = (filter.value||'').toLowerCase().trim();
      const pilotOnly = !!onlyPilot.checked;
      resultList.innerHTML = '';

      // Filtering by: mngno, title, artist
      let list = allItems.filter(it=>{
        if(pilotOnly && !it.pilot) return false;
        if(!q) return true;
        const hay = `${it.mngno} ${it.title} ${it.artist}`.toLowerCase();
        return hay.includes(q);
      });

      // Sort: pilot first, then by mngno
      list.sort((a,b)=> (b.pilot?1:0) - (a.pilot?1:0) || a.mngno.localeCompare(b.mngno));

      // Render rows
      list.forEach(it=>{
        const row = el('div','item');
        if(it.pilot) row.style.background = 'linear-gradient(0deg, rgba(58,66,88,.15), rgba(58,66,88,.15))';

        const left = el('div','left');
        const m = el('span','mng'); m.textContent = it.mngno;
        const t = el('div'); t.textContent = it.title || '(ì œëª© ì—†ìŒ)';
        t.style.fontWeight='700';
        left.appendChild(t);
        left.appendChild(m);

        const right = el('div','right');
        if(it.pilot){
          const b = el('span','badge pilot-badge'); b.textContent='ì‹¤ì¦ìš©'; right.appendChild(b);
          if(it.url){
            const a = document.createElement('a'); a.href=it.url; a.target='_blank'; a.rel='noopener noreferrer';
            a.className='badge'; a.textContent='ìƒì„¸ë³´ê¸°'; right.appendChild(a);
          }
        }
        const pick = el('button','btn'); pick.textContent='ì„ íƒ'; pick.title='ì´ mngnoë¡œ ëŒ€í™” ì‹œì‘';
        pick.addEventListener('click', ()=> setMngno(it.mngno));
        right.appendChild(pick);

        row.appendChild(left); row.appendChild(right);
        // Also clicking anywhere selects
        row.addEventListener('click', (e)=>{ if(e.target===pick) return; setMngno(it.mngno); });
        resultList.appendChild(row);
      });
    }

    // ======================================================
    // NETWORKING (CHAT)
    // ======================================================
    async function askLLM(question, retry=0){
      if(!currentMngno){ addMessage('ë¨¼ì € ì˜¤ë¥¸ìª½ì—ì„œ ê´€ë¦¬ë²ˆí˜¸(mngno)ë¥¼ ì„ íƒ/ì…ë ¥í•˜ì„¸ìš”.', 'system'); return; }
      const payload = { mngno: currentMngno, question, is_youth: false, session_id: sessionId ?? null };
      try{
        const res = await fetch(ENDPOINT, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        if(res.status===500){
          if(retry<3){ addMessage(`ì„œë²„ 500 ì˜¤ë¥˜, ì¬ì‹œë„ ${retry+1}/3â€¦`, 'system'); return askLLM(question, retry+1); }
          addMessage('3íšŒ ì¬ì‹œë„ í›„ì—ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'system'); return;
        }
        const data = await res.json();
        if(data.id) setSession(data.id);
        const answer = data.answer || '(ì‘ë‹µì— answer í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤)';
        lastAIMsg = answer; addMessage('ğŸ‘©ğŸ»â€ğŸ« '+answer, 'ai');
        if(USE_TTS) speak(answer);
      }catch(err){ addMessage('ìš”ì²­ ì‹¤íŒ¨: '+(err && err.message ? err.message: err), 'system'); }
    }

    // ======================================================
    // TTS (Web Speech)
    // ======================================================
    let speaking = false;
    function speak(text){
      try{
        const u = new SpeechSynthesisUtterance(text); u.lang='ko-KR'; u.rate=1; u.onend=()=>{speaking=false};
        speaking=true; speechSynthesis.speak(u);
      }catch(e){}
    }
    function stopSpeak(){ try{ speechSynthesis.cancel(); speaking=false; }catch(e){} }

    // ======================================================
    // EVENTS
    // ======================================================
    sendBtn.addEventListener('click', ()=>{ const q = inputEl.value.trim(); if(!q) return; addMessage('âŒ¨ï¸ '+q,'me'); inputEl.value=''; hideAC(); askLLM(q); });
    inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); } });
    inputEl.addEventListener('input', ()=>{
      const val = inputEl.value.trim().toLowerCase();
      const merged = Object.values(EXAMPLES).flat();
      const list = val ? merged.filter(v=>v.toLowerCase().includes(val)).slice(0,20) : [];
      acList.innerHTML = '';
      list.forEach(q=>{ const li=document.createElement('li'); li.textContent=q; li.addEventListener('click',()=>{ inputEl.value=q; hideAC(); inputEl.focus(); }); acList.appendChild(li); });
      acBox.style.display = list.length? 'block':'none';
    });

    applyMng.addEventListener('click', ()=>{ const v=mngInput.value.trim(); if(v) setMngno(v); });
    filter.addEventListener('input', renderSampleList);
    speakBtn.addEventListener('click', ()=>{ if(speaking) stopSpeak(); else if(lastAIMsg) speak(lastAIMsg); });
    onlyPilot.addEventListener('change', renderSampleList);

    // ======================================================
    // INIT
    // ======================================================
    function addHello(){
      addMessage('ì•ˆë…•í•˜ì„¸ìš”. êµ­ë¦½í˜„ëŒ€ë¯¸ìˆ ê´€ì˜ ì‘í’ˆê³¼ ì‘ê°€ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ë©´ ì–¸ì œë“ ì§€ ë¬¼ì–´ë³´ì„¸ìš”. ë„ì›€ì´ ë˜ê² ìŠµë‹ˆë‹¤.', 'ai');
      addMessage('ì˜¤ë¥¸ìª½ì—ì„œ mngnoë¥¼ ì„ íƒí•˜ì‹œë©´ í•´ë‹¹ ì‘í’ˆìœ¼ë¡œ ëŒ€í™”ê°€ ì‹œì‘ë©ë‹ˆë‹¤. (ì‹¤ì¦ìš© 9ê°œëŠ” ë°°ì§€ í‘œì‹œ)', 'ai');
    }
    function restoreSession(){ if(sessionId) sidEl.textContent = sessionId.slice(0,8); }

    renderCategories();
    restoreSession();
    addHello();
    loadDeviceInfo(); // load full list from deviceInfo.json and render
  </script>
</body>
</html>
